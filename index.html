<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heart Game - Math Puzzle</title>
<style>
/* === RESET === */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1px;
    overflow: hidden;
    position: relative;
}

/* ‚ù§Ô∏è Floating Hearts Background */
.hearts {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    overflow: hidden;
    z-index: 0;
    pointer-events: none;
}
.hearts span {
    position: absolute;
    display: block;
    width: 25px; height: 25px;
    background: rgba(255, 0, 80, 0.8);
    animation: floatHearts 10s linear infinite;
    bottom: -30px;
    clip-path: polygon(50% 0%, 61% 19%, 98% 19%, 68% 38%, 
                      79% 75%, 50% 55%, 21% 75%, 32% 38%, 
                      2% 19%, 39% 19%);
}
@keyframes floatHearts {
    0% {transform: translateY(0) scale(1) rotate(0deg);opacity: 1;}
    100% {transform: translateY(-800px) scale(1.5) rotate(360deg);opacity: 0;}
}

/* === Containers === */
.container {
    background: white;
    border-radius: 10px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    padding: 20px;
    max-width: 400px;
    width: 100%;
    z-index: 10;
    position: relative;
    display: none;
    opacity: 0;
    transform: translateY(15px);
    transition: all 0.4s ease;
}
.container.show {
    display: block;
    opacity: 1;
    transform: translateY(0);
}
h1, h2 {
    color: #667eea;
    text-align: center;
    margin-bottom: 10px;
}

/* === Login Page === */
.login-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
input[type="email"], input[type="password"], input[type="text"] {
    padding: 10px;
    border: 1.5px solid #667eea;
    border-radius: 6px;
    font-size: 1em;
    outline: none;
    transition: all 0.3s;
}
input[type="email"]:focus, input[type="password"]:focus, input[type="text"]:focus {
    border-color: #5568d3;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}
button {
    padding: 8px;
    border: none;
    border-radius: 6px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
}
.btn-primary {
    background: #667eea;
    color: white;
}
.btn-primary:hover {
    background: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}
.btn-danger {
    background: #dc3545;
    color: white;
}
.btn-danger:hover {
    background: #c82333;
}
.btn-success {
    background: #28a745;
    color: white;
}
.btn-success:hover {
    background: #218838;
}
.btn-secondary {
    background: #6c757d;
    color: white;
}

.divider {
    text-align: center;
    margin: 15px 0;
    color: #666;
    position: relative;
}
.divider::before,
.divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background: #ddd;
}
.divider::before { left: 0; }
.divider::after { right: 0; }

.toggle-auth {
    text-align: center;
    margin-top: 15px;
    color: #666;
    font-size: 0.9em;
}
.toggle-auth a {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    cursor: pointer;
}
.toggle-auth a:hover {
    text-decoration: underline;
}

/* === Dashboard === */
.dashboard {
    text-align: center;
}
.user-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}
.user-avatar {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2em;
    font-weight: bold;
    border: 3px solid #667eea;
}
.dashboard p {
    margin: 10px 0;
}
.dashboard button {
    width: 100%;
    margin-top: 10px;
}

/* === Game Container === */
.game-container {
    text-align: center;
}
.game-info {
    display: flex;
    justify-content: space-around;
    margin-bottom: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 5px;
}
.info-item { text-align: center; }
.info-label { font-size: 0.7em; color: #666; }
.info-value { font-size: 0.9em; font-weight: bold; color: #667eea; }

.puzzle-area {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 6px;
    margin: 10px auto;
    text-align: center;
    max-width: 270px;
}
#puzzleImage {width: 260px;border-radius: 6px;margin-bottom: 5px;}
.loading {color: #667eea;font-size: 0.9em;}

.answer-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    margin-bottom: 10px;
}
.answer-btn {
    border: 1.3px solid #667eea;
    background: white;
    color: #667eea;
    padding: 6px;
    border-radius: 6px;
    font-weight: bold;
}
.answer-btn:hover {
    background: #667eea;
    color: white;
}

.feedback {
    margin: 8px 0;
    padding: 6px;
    border-radius: 6px;
    display: none;
}
.feedback.correct {background: #d4edda; color: #155724;}
.feedback.incorrect {background: #f8d7da; color: #721c24;}

#nextBtn, #quitBtn {width: 100%; margin-top: 8px;}

/* === Modal === */
.modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 50;
}
.modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
}
.modal-content button {margin: 5px;}

/* === Answer Input === */
#answerInput {
    width: 78%;
    padding: 6px 1px;
    border: 1.5px solid #667eea;
    border-radius: 6px;
    font-size: 1em;
    text-align: center;
    margin: 2px 0;
    outline: none;
    transition: all 0.3s ease;
    color: #333;
}

.error-msg {
    color: #dc3545;
    font-size: 0.85em;
    margin-top: 5px;
    display: none;
}
</style>
</head>
<body>
<div class="hearts">
    <span style="left:10%; animation-delay: 0s;"></span>
    <span style="left:20%; animation-delay: 2s;"></span>
    <span style="left:30%; animation-delay: 4s;"></span>
    <span style="left:40%; animation-delay: 6s;"></span>
    <span style="left:50%; animation-delay: 1s;"></span>
    <span style="left:60%; animation-delay: 3s;"></span>
    <span style="left:70%; animation-delay: 5s;"></span>
    <span style="left:80%; animation-delay: 7s;"></span>
</div>

<!-- LOGIN PAGE -->
<div class="container show" id="loginPage">
    <h2>‚ù§Ô∏è Heart Math Puzzle</h2>
    <div class="login-form">
        <input type="text" id="loginName" placeholder="Enter your name" required>
        <input type="email" id="loginEmail" placeholder="Enter your email" required>
        <input type="password" id="loginPassword" placeholder="Enter password (min 6 chars)" required>
        <div class="error-msg" id="loginError"></div>
        <button class="btn-primary" id="loginBtn">Sign In</button>
        <div class="toggle-auth">
            Don't have an account? <a id="showSignup">Sign Up</a>
        </div>
    </div>
</div>

<!-- SIGNUP PAGE -->
<div class="container" id="signupPage">
    <h2>‚ù§Ô∏è Create Account</h2>
    <div class="login-form">
        <input type="text" id="signupName" placeholder="Full Name" required>
        <input type="email" id="signupEmail" placeholder="Email Address" required>
        <input type="password" id="signupPassword" placeholder="Password (min 6 chars)" required>
        <input type="password" id="signupConfirm" placeholder="Confirm Password" required>
        <div class="error-msg" id="signupError"></div>
        <button class="btn-success" id="signupBtn">Create Account</button>
        <div class="toggle-auth">
            Already have an account? <a id="showLogin">Sign In</a>
        </div>
    </div>
</div>

<!-- DASHBOARD -->
<div class="container" id="dashboardPage">
    <h2>üè† Dashboard</h2>
    <div class="dashboard">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar"></div>
            <div>
                <p><strong id="userName"></strong></p>
                <p style="font-size: 0.9em; color: #666;" id="userEmail"></p>
            </div>
        </div>
        <p><strong>Total Score:</strong> <span id="userScore">0</span></p>
        <p><strong>Games Played:</strong> <span id="gamesPlayed">0</span></p>
        <button class="btn-success" id="playBtn">Start Game</button>
        <button class="btn-danger" id="logoutBtn">Logout</button>
    </div>
</div>

<!-- GAME CONTAINER -->
<div class="container" id="gameContainer">
    <h1>üéÆ Heart Math Puzzle</h1>
    <div class="game-info">
        <div class="info-item"><div class="info-label">Score</div><div class="info-value" id="score">0</div></div>
        <div class="info-item"><div class="info-label">Correct</div><div class="info-value" id="correct">0</div></div>
        <div class="info-item"><div class="info-label">Wrong</div><div class="info-value" id="wrong">0</div></div>
    </div>
    <div class="puzzle-area">
        <div id="loadingText" class="loading">Loading puzzle...</div>
        <img id="puzzleImage" style="display:none;" alt="Math Puzzle">
    </div>
    <div class="feedback" id="feedback"></div>
    <div class="answer-grid" id="answerGrid"></div>
    <input type="number" id="answerInput" placeholder="Enter answer">
    <button class="btn-primary" id="submitBtn">Submit</button>
    <button class="btn-success" id="nextBtn">Next Puzzle</button>
    <button class="btn-danger" id="quitBtn">Quit Game</button>
</div>

<!-- Quit Modal -->
<div class="modal" id="quitModal">
    <div class="modal-content">
        <h3>Quit Game?</h3>
        <p>Your progress will be saved.</p>
        <button class="btn-danger" id="confirmQuit">Yes, Quit</button>
        <button class="btn-primary" id="cancelQuit">Cancel</button>
    </div>
</div>

<script>
// ========== AUTHENTICATION SYSTEM ==========
class AuthSystem {
    constructor() {
        this.users = JSON.parse(localStorage.getItem('users')) || {};
        this.currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
    }

    signup(name, email, password, confirmPassword) {
        // Validation
        if (!name || !email || !password) {
            return { success: false, message: 'All fields are required' };
        }
        if (password.length < 6) {
            return { success: false, message: 'Password must be at least 6 characters' };
        }
        if (password !== confirmPassword) {
            return { success: false, message: 'Passwords do not match' };
        }
        if (this.users[email]) {
            return { success: false, message: 'Email already registered' };
        }

        // Create user
        this.users[email] = {
            name: name,
            email: email,
            password: password, // In real app, hash this!
            score: 0,
            gamesPlayed: 0,
            createdAt: new Date().toISOString()
        };
        
        localStorage.setItem('users', JSON.stringify(this.users));
        return { success: true, message: 'Account created successfully!' };
    }

    login(name, email, password) {
        if (!email || !password) {
            return { success: false, message: 'Email and password are required' };
        }

        const user = this.users[email];
        if (!user) {
            return { success: false, message: 'Account not found. Please sign up.' };
        }
        if (user.password !== password) {
            return { success: false, message: 'Incorrect password' };
        }

        // Update name if provided
        if (name && name.trim()) {
            user.name = name;
            this.users[email] = user;
            localStorage.setItem('users', JSON.stringify(this.users));
        }

        this.currentUser = user;
        sessionStorage.setItem('currentUser', JSON.stringify(user));
        return { success: true, user: user };
    }

    logout() {
        sessionStorage.removeItem('currentUser');
        this.currentUser = null;
    }

    updateScore(score, gamesPlayed) {
        if (this.currentUser) {
            this.currentUser.score = score;
            this.currentUser.gamesPlayed = gamesPlayed;
            this.users[this.currentUser.email] = this.currentUser;
            localStorage.setItem('users', JSON.stringify(this.users));
            sessionStorage.setItem('currentUser', JSON.stringify(this.currentUser));
        }
    }
}

const auth = new AuthSystem();

// ========== GAME CLASS ==========
class HeartGame {
    constructor() {
        this.apiUrl = 'https://marcconrad.com/uob/heart/api.php';
        this.currentSolution = null;
        this.sessionScore = 0;
        this.correct = 0;
        this.wrong = 0;
        this.hasAnswered = false;
        this.gamesPlayed = auth.currentUser?.gamesPlayed || 0;

        this.el = {
            puzzleImage: document.getElementById('puzzleImage'),
            loadingText: document.getElementById('loadingText'),
            answerGrid: document.getElementById('answerGrid'),
            answerInput: document.getElementById('answerInput'),
            submitBtn: document.getElementById('submitBtn'),
            nextBtn: document.getElementById('nextBtn'),
            feedback: document.getElementById('feedback'),
            score: document.getElementById('score'),
            correct: document.getElementById('correct'),
            wrong: document.getElementById('wrong')
        };
        this.init();
    }

    init() {
        this.el.submitBtn.onclick = () => this.checkAnswer();
        this.el.nextBtn.onclick = () => this.loadPuzzle();
        this.el.answerInput.onkeypress = (e) => { if (e.key === 'Enter') this.checkAnswer(); };
        this.updateUI();
        this.loadPuzzle();
    }

    async loadPuzzle() {
        this.hasAnswered = false;
        this.el.feedback.style.display = 'none';
        this.el.loadingText.style.display = 'block';
        this.el.puzzleImage.style.display = 'none';
        this.el.nextBtn.style.display = 'none';
        this.el.answerInput.value = '';

        try {
            const res = await fetch(this.apiUrl);
            const data = await res.json();
            this.currentSolution = data.solution;
            this.el.puzzleImage.src = data.question;
            this.el.puzzleImage.onload = () => {
                this.el.loadingText.style.display = 'none';
                this.el.puzzleImage.style.display = 'block';
            };
            this.generateAnswers();
        } catch {
            this.el.loadingText.textContent = 'Error loading puzzle.';
        }
    }

    generateAnswers() {
        const answers = new Set([this.currentSolution]);
        while (answers.size < 9) answers.add(Math.floor(Math.random() * 20));
        this.el.answerGrid.innerHTML = '';
        Array.from(answers).sort(() => Math.random() - 0.5).forEach(num => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn';
            btn.textContent = num;
            btn.onclick = () => {
                this.el.answerInput.value = num;
                this.checkAnswer();
            };
            this.el.answerGrid.appendChild(btn);
        });
    }

    checkAnswer() {
        if (this.hasAnswered) return;
        const ans = parseInt(this.el.answerInput.value);
        if (isNaN(ans)) {
            alert("Enter a valid number");
            return;
        }
        this.hasAnswered = true;
        if (ans === this.currentSolution) {
            this.sessionScore += 10; 
            this.correct++;
            this.showFeedback("‚úÖ Correct!", true);
        } else {
            this.wrong++;
            this.showFeedback(`‚ùå Wrong! Correct: ${this.currentSolution}`, false);
        }
        this.updateUI();
        this.el.nextBtn.style.display = 'block';
        
        // Update user's total score
        const totalScore = (auth.currentUser?.score || 0) + this.sessionScore;
        auth.updateScore(totalScore, this.gamesPlayed);
    }

    showFeedback(msg, correct) {
        this.el.feedback.textContent = msg;
        this.el.feedback.className = 'feedback ' + (correct ? 'correct' : 'incorrect');
        this.el.feedback.style.display = 'block';
    }

    updateUI() {
        this.el.score.textContent = this.sessionScore;
        this.el.correct.textContent = this.correct;
        this.el.wrong.textContent = this.wrong;
    }
}

// ========== PAGE HANDLING ==========
const loginPage = document.getElementById('loginPage');
const signupPage = document.getElementById('signupPage');
const dashboardPage = document.getElementById('dashboardPage');
const gameContainer = document.getElementById('gameContainer');
const quitModal = document.getElementById('quitModal');

// Login
document.getElementById('loginBtn').onclick = () => {
    const name = document.getElementById('loginName').value.trim();
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorEl = document.getElementById('loginError');

    const result = auth.login(name, email, password);
    if (result.success) {
        errorEl.style.display = 'none';
        showDashboard();
    } else {
        errorEl.textContent = result.message;
        errorEl.style.display = 'block';
    }
};

// Signup
document.getElementById('signupBtn').onclick = () => {
    const name = document.getElementById('signupName').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirm = document.getElementById('signupConfirm').value;
    const errorEl = document.getElementById('signupError');

    const result = auth.signup(name, email, password, confirm);
    if (result.success) {
        errorEl.style.display = 'none';
        alert('Account created! Please sign in.');
        showLogin();
    } else {
        errorEl.textContent = result.message;
        errorEl.style.display = 'block';
    }
};

// Toggle between login and signup
document.getElementById('showSignup').onclick = () => {
    loginPage.classList.remove('show');
    signupPage.classList.add('show');
};

document.getElementById('showLogin').onclick = () => {
    signupPage.classList.remove('show');
    loginPage.classList.add('show');
};

// Logout
document.getElementById('logoutBtn').onclick = () => {
    auth.logout();
    showLogin();
};

// Play game
document.getElementById('playBtn').onclick = () => {
    dashboardPage.classList.remove('show');
    gameContainer.classList.add('show');
    if (auth.currentUser) {
        auth.currentUser.gamesPlayed++;
        auth.updateScore(auth.currentUser.score, auth.currentUser.gamesPlayed);
    }
    new HeartGame();
};

// Quit game
document.getElementById('quitBtn').onclick = () => quitModal.style.display = 'flex';
document.getElementById('cancelQuit').onclick = () => quitModal.style.display = 'none';
document.getElementById('confirmQuit').onclick = () => {
    quitModal.style.display = 'none';
    gameContainer.classList.remove('show');
    showDashboard();
};

function showLogin() {
    loginPage.classList.add('show');
    signupPage.classList.remove('show');
    dashboardPage.classList.remove('show');
    gameContainer.classList.remove('show');
    document.getElementById('loginError').style.display = 'none';
}

function showDashboard() {
    if (auth.currentUser) {
        const initials = auth.currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
        document.getElementById('userAvatar').textContent = initials;
        document.getElementById('userName').textContent = auth.currentUser.name;
        document.getElementById('userEmail').textContent = auth.currentUser.email;
        document.getElementById('userScore').textContent = auth.currentUser.score;
        document.getElementById('gamesPlayed').textContent = auth.currentUser.gamesPlayed;
        
        loginPage.classList.remove('show');
        signupPage.classList.remove('show');
        dashboardPage.classList.add('show');
    } else {
        showLogin();
    }
}

// Auto-load correct page
if (auth.currentUser) {
    showDashboard();
} else {
    showLogin();
}
</script>
</body>
</html>
